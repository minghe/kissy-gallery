KISSY.add("gallery/form/1.1/uploader/themes/imageUploader/index",function(g,i,j){function h(a){h.superclass.constructor.call(this,a)}var e=i.all;g.extend(h,j,{afterUploaderRender:function(a){var b=this.get("oPlugin").preview,c=this.get("queue");if(b){b=new b;this.set("preview",b)}this._maxHideBtn(a);this._renderFiledrop();c.on("add",this._addFileHandler,this)},_addFileHandler:function(a){a=a.file;var b=a.target,c=e(".J_Del_"+a.id),d=e(".J_Mask_"+a.id);b.on("mouseover mouseout",function(f){if(f.type==
"mouseover"){c.show();d.show()}else{c.hide();d.hide()}});c.data("data-file",a);c.on("click",this._delHandler,this)},_getStatusWrapper:function(a){return a.children(".J_FileStatus")},_renderFiledrop:function(){var a=this.get("button").get("target"),b=this.get("oPlugin").filedrop;if(!b)return false;a=new b({target:a,uploader:this.get("uploader"),tpl:{supportDrop:'<div class="drop-wrapper"></div>'}});a.render();return a},_waitingHandler:function(a){var b=this.get("preview"),c=a.file,d=c.input;c=e(".J_Pic_"+
c.id);b&&d&&c.length&&b.preview(a.file.input,c)},_startHandler:function(a){var b=a.uploader,c=a.index,d=this.get("queue");b=b.get("type");a=e(".J_ProgressBar_"+a.id);if(b=="ajax"||b=="flash"){b=this.get("oPlugin").progressBar;var f;if(b){f=new b(a);f.render();this.set("progressBar",f)}d.updateFile(c,{progressBar:f})}},_progressHandler:function(a){var b=a.file.progressBar;if(!b)return false;b.set("value",Math.ceil(a.loaded/a.total*100))},_successHandler:function(a){var b=a.file.result;this._setCount();
b&&this._changeImageSrc(a.id,b);this._setDisplayMsg(false,a.file)},_errorHandler:function(a){var b=a.msg;e(".J_ErrorMsg_"+a.id).html(b);this._setDisplayMsg(true,a.file);g.log(b)},_setCount:function(){var a=e(this.get("elCount")),b=this.getFilesLen(),c=this.get("auth"),d=this.get("uploader").get("button");if(!c)return false;c=c.get("rules").max;if(!c)return false;if(b<c[0]){d.show();(d=d.get("target").parent("li"))&&d.show()}a.length&&a.text(c[0]-b)},_setDisplayMsg:function(a,b){if(!b)return false;
var c=e(".J_Mask_"+b.id),d=b.statusWrapper;c[a&&"show"||"hide"]();if(a){c.show();d.show()}else{c.hide();d.hide()}},_maxHideBtn:function(a){var b=this.get("auth");if(b=="")return false;b.on("error",function(c){c=c.rule;var d=a.get("button"),f=d.get("target");if(c=="max"){d.hide();(c=f.parent("li"))&&c.hide()}})},_delHandler:function(a){var b=this.get("uploader"),c=this.get("queue");a=e(a.target).data("data-file");c=c.getFileIndex(a.id);a=a.status;if(a=="start"||a=="progress")b.cancel(c);this._setCount()},
getFilesLen:function(a){a||(a="success");return this.get("queue").getFiles(a).length},_changeImageSrc:function(a,b){var c=b.data,d=e(".J_Pic_"+a);if(!g.isObject(c))return false;c=c.url;if(d.attr("src")==""||g.UA.ie==8)d.attr("src",c)}},{ATTRS:{name:{value:"imageUploader"},cssUrl:{value:"gallery/form/1.1/uploader/themes/imageUploader/style.css"},fileTpl:{value:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="tb-pic120"><a href="javascript:void(0);"><img class="J_Pic_{id}" src="" /></a></div><div class=" J_Mask_{id} pic-mask"></div><div class="status-wrapper J_FileStatus"><div class="status waiting-status tips-upload-waiting"><p class="tips-text">等待上传，请稍候</p></div><div class="status start-status progress-status tips-uploading"><div class="J_ProgressBar_{id}"><s class="loading-icon"></s>上传中...</div></div><div class="status success-status tips-upload-success">上传成功！</div><div class="status error-status tips-upload-error"><p class="J_ErrorMsg_{id} tips-text">上传失败，请重试！</p></div></div><a class="J_Del_{id} del-pic" href="#">删除</a></li>'},
plugins:{value:["preview","progressBar","filedrop"]},elCount:{value:"#J_UploadCount"}}});return h},{requires:["node","../../theme"]});
