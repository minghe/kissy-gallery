/**
 * @fileoverview 图片上传主题（带图片预览），第一版由紫英同学完成，苏河同学做了大量优化，明河整理优化
 * @author 苏河、紫英、明河
 **/KISSY.add("gallery/form/1.2/uploader/themes/imageUploader/index",function(e,t,n){function s(e){var t=this;s.superclass.constructor.call(t,e)}var r="",i=t.all;return e.extend(s,n,{afterUploaderRender:function(){var e=this,t=e.get("queue");e._renderFiledrop(),t.on("add",e._addFileHandler,e)},_addFileHandler:function(e){var t=this,n=e.file,r=n.target,s=i(".J_Del_"+n.id),o=i(".J_Mask_"+n.id);r.on("mouseover mouseout",function(e){e.type=="mouseover"?(s.show(),o.show()):(s.hide(),o.hide())}),s.data("data-file",n),s.on("click",t._delHandler,t)},_getStatusWrapper:function(e){return e&&e.children(".J_FileStatus")||i("")},_renderFiledrop:function(){var e=this,t=e.get("button"),n=t.get("target"),r=e.get("oPlugin").filedrop,i;return r?(i=new r({target:n,uploader:this.get("uploader"),tpl:{supportDrop:'<div class="drop-wrapper"></div>'}}),i.render(),i):!1},_waitingHandler:function(e){},_startHandler:function(e){var t=this,n=e.uploader,r=e.index,s=t.get("queue"),o=n.get("type"),u=i(".J_ProgressBar_"+e.id);if(o=="ajax"||o=="flash"){var a=t.get("oPlugin").progressBar,f;a&&(f=new a(u),f.on("change",function(e){e.value==100&&(f.hide(),t._setDisplayMsg(!1,e.file))}),f.render(),t.set("progressBar",f)),s.updateFile(r,{progressBar:f})}},_progressHandler:function(e){var t=e.file,n=e.loaded,r=e.total,i=Math.ceil(n/r*100),s=t.progressBar;if(!s)return!1;s.set("value",i)},_successHandler:function(e){var t=this,n=e.file,r=n.id,s=n.result,o=n.progressBar;t._setCount(),s&&t._changeImageSrc(e.id,s);if(!o)return i(".J_ProgressBar_"+r).hide(),t._setDisplayMsg(!1,e.file),!1;o.set("value",100),i(".J_Mask_"+r).hide()},_errorHandler:function(t){var n=this,r=t.msg,s=t.id;i(".J_ErrorMsg_"+s).html(r),n._setDisplayMsg(!0,t.file),e.log(r)},_setCount:function(){var e=this,t=i(e.get("elCount")),n=e.getFilesLen(),r=e.get("auth");if(!r)return!1;var s=r.get("rules"),o=s.max;if(!o)return!1;t.length&&t.text(o[0]-n)},_setDisplayMsg:function(e,t){if(!t)return!1;var n=i(".J_Mask_"+t.id);n[e&&"show"||"hide"](),e?n.show():n.hide()},_delHandler:function(e){var t=this,n=t.get("uploader"),r=t.get("queue"),s=i(e.target).data("data-file"),o=r.getFileIndex(s.id),u=s.status;(u=="start"||u=="progress")&&n.cancel(o),t._setCount()},getFilesLen:function(e){e||(e="success");var t=this,n=t.get("queue"),r=n.getFiles(e);return r.length},_changeImageSrc:function(t,n){var s=n.data,o,u=i(".J_Pic_"+t);if(!e.isObject(s))return!1;o=s.url,u.attr("src")==r&&(u.show(),u.attr("src",o))}},{ATTRS:{name:{value:"imageUploader"},cssUrl:{value:"gallery/form/1.2/uploader/themes/imageUploader/style.css"},fileTpl:{value:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="tb-pic120"><a href="javascript:void(0);"><img class="J_Pic_{id}" src="" /></a></div><div class=" J_Mask_{id} pic-mask"></div><div class="status-wrapper J_FileStatus"><div class="status waiting-status tips-upload-waiting"><p class="tips-text">\u7b49\u5f85\u4e0a\u4f20\uff0c\u8bf7\u7a0d\u5019</p></div><div class="status start-status progress-status success-status tips-uploading"><div class="J_ProgressBar_{id}"><s class="loading-icon"></s>\u4e0a\u4f20\u4e2d...</div></div><div class="status error-status tips-upload-error"><p class="J_ErrorMsg_{id} tips-text">\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01</p></div></div><a class="J_Del_{id} del-pic" href="#">\u5220\u9664</a></li>'},plugins:{value:["progressBar","filedrop"]},elCount:{value:"#J_UploadCount"},isMaxHideBtn:{value:!0}}}),s},{requires:["node","../../theme"]});